<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>实现领域驱动设计-实现：构建块 | Knowledge Base</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="知识分享">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.40203021.css" as="style"><link rel="preload" href="/assets/js/app.3aafe313.js" as="script"><link rel="preload" href="/assets/js/4.95e160e0.js" as="script"><link rel="preload" href="/assets/js/1.885e2cda.js" as="script"><link rel="preload" href="/assets/js/7.8cb06d6a.js" as="script"><link rel="prefetch" href="/assets/js/10.f651c5d0.js"><link rel="prefetch" href="/assets/js/11.0202aa7c.js"><link rel="prefetch" href="/assets/js/12.68bed038.js"><link rel="prefetch" href="/assets/js/13.806c5d35.js"><link rel="prefetch" href="/assets/js/14.835cd0e5.js"><link rel="prefetch" href="/assets/js/15.0f7d2781.js"><link rel="prefetch" href="/assets/js/16.939380ef.js"><link rel="prefetch" href="/assets/js/17.574eee2b.js"><link rel="prefetch" href="/assets/js/18.fdabd8e4.js"><link rel="prefetch" href="/assets/js/19.33fb9403.js"><link rel="prefetch" href="/assets/js/20.c51ffc88.js"><link rel="prefetch" href="/assets/js/21.69c964ac.js"><link rel="prefetch" href="/assets/js/22.830f4979.js"><link rel="prefetch" href="/assets/js/23.a5e4964d.js"><link rel="prefetch" href="/assets/js/24.32ae63e9.js"><link rel="prefetch" href="/assets/js/5.d12685fc.js"><link rel="prefetch" href="/assets/js/6.16927f8b.js"><link rel="prefetch" href="/assets/js/8.9c3cd34a.js"><link rel="prefetch" href="/assets/js/9.e259e7a9.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.b00b6eb1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.40203021.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>Knowledge Base</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>知识分享</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>Gerry Ge</span>
            
          <span data-v-4e82dffc>2019 - </span>
          2021
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Knowledge Base" class="logo"> <span class="site-name">Knowledge Base</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/ABP/" class="nav-link"><i class="undefined"></i>
  ABP
</a></li><li class="dropdown-item"><!----> <a href="/categories/MICROSERVICE/" class="nav-link"><i class="undefined"></i>
  MICROSERVICE
</a></li><li class="dropdown-item"><!----> <a href="/categories/DDD/" class="nav-link"><i class="undefined"></i>
  DDD
</a></li><li class="dropdown-item"><!----> <a href="/categories/.NET/" class="nav-link"><i class="undefined"></i>
  .NET
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  Time Line
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/gerryge" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    Gerry Ge
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>13</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>4</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/ABP/" class="nav-link"><i class="undefined"></i>
  ABP
</a></li><li class="dropdown-item"><!----> <a href="/categories/MICROSERVICE/" class="nav-link"><i class="undefined"></i>
  MICROSERVICE
</a></li><li class="dropdown-item"><!----> <a href="/categories/DDD/" class="nav-link"><i class="undefined"></i>
  DDD
</a></li><li class="dropdown-item"><!----> <a href="/categories/.NET/" class="nav-link"><i class="undefined"></i>
  .NET
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  Time Line
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/gerryge" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><a href="/blogs/2021/Implementing_Domain_Driven_Design/01_Introduction.html" class="sidebar-link">引言</a></li><li><a href="/blogs/2021/Implementing_Domain_Driven_Design/02_What_Is_DDD.html" class="sidebar-link">DDD是什么</a></li><li><a href="/blogs/2021/Implementing_Domain_Driven_Design/03_Implementation_The_Big_Picture.html" class="sidebar-link">实现：全景图</a></li><li><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html" aria-current="page" class="active sidebar-link">实现：构建块</a></li><li><a href="/blogs/2021/Implementing_Domain_Driven_Design/05_Example_User_Cases.html" class="sidebar-link">用例</a></li><li><a href="/blogs/2021/Implementing_Domain_Driven_Design/06_Domain_Logic_Application_Logic.html" class="sidebar-link">领域逻辑与应用逻辑</a></li><li><a href="/blogs/2021/Implementing_Domain_Driven_Design/07_Reference_Books.html" class="sidebar-link">引用书籍</a></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>实现领域驱动设计-实现：构建块</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>Gerry Ge</span>
            
          <span data-v-4e82dffc>2019 - </span>
          2021
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">实现领域驱动设计-实现：构建块</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>Gerry Ge</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>7/18/2021</span></i> <i class="iconfont reco-eye" data-v-1ff7123e><span id="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-1ff7123e><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>ABP</span><span class="tag-item" data-v-1ff7123e>DDD</span></i></div></div> <div class="theme-reco-content content__default"><p>本系列文章，翻译至<a href="https://abp.io/books/implementing-domain-driven-design" target="_blank" rel="noopener noreferrer">Implementing Domain Driven Design<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h1 id="实现-构建块"><a href="#实现-构建块" class="header-anchor">#</a> 实现：构建块</h1> <p>这是本指南的重要部分。我们将通过示例介绍和解释一些<strong>显式规则</strong>。在实施领域驱动设计时，您可以遵循这些规则并应用到您的解决方案中。</p> <h2 id="领域示例"><a href="#领域示例" class="header-anchor">#</a> 领域示例</h2> <p>示例将使用 GitHub 使用的一些耳熟能详的概念，例如<code>Issue</code>、<code>Repository</code>、<code>Label</code>和<code>User</code>。下图显示了一些聚合、聚合根、实体、值对象以及它们之间的关系：</p> <p><img src="/assets/img/image-20210719213146321.dffd19bb.png" alt="image-20210719213146321"></p> <p><code>Issue Aggregate</code> 由一个 <code>Issue Aggregate Root</code> 组成，其中包含 <code>Comment</code> 和 <code>IssueLabel</code> 集合。其他聚合只简单显示，因为我们将关注<code>Issue Aggregate</code>：</p> <p><img src="/assets/img/image-20210719213000930.36ced7f4.png" alt="image-20210719213000930"></p> <h2 id="聚合"><a href="#聚合" class="header-anchor">#</a> 聚合</h2> <p>如前所述，<a href="https://docs.abp.io/en/abp/latest/Entities" target="_blank" rel="noopener noreferrer">聚合<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是由聚合根对象绑定在一起的一组对象（实体和值对象）。本节将介绍与聚合相关的原则和规则。</p> <div class="custom-block tip"><p class="title"></p><p>除非我们明确编写聚合根或子集合实体，否则我们将术语实体称为聚合根和子集合实体。</p></div><h2 id="聚合-聚合根原则"><a href="#聚合-聚合根原则" class="header-anchor">#</a> 聚合/聚合根原则</h2> <h3 id="业务规则"><a href="#业务规则" class="header-anchor">#</a> 业务规则</h3> <p>实体负责执行与其自身属性相关的业务规则。聚合根实体还负责其子集合实体。</p> <p>聚合应该通过实施领域规则和约束来保持其<strong>自我完整性</strong>和<strong>有效性</strong>。这意味着，与 DTO 不同，实体具有<strong>实现某些业务逻辑的方法</strong>。实际上，我们应该尽可能地在实体中实现业务规则。</p> <h3 id="单个单元"><a href="#单个单元" class="header-anchor">#</a> 单个单元</h3> <p>聚合被检索并保存为一个单元，包含所有子集合和属性。例如，如果您想对<code>Issue</code>添加<code>Comment</code>，则需要；</p> <ul><li>从数据库中获取<code>Issue</code>，包括所有子集合（<code>Comments</code> 和 <code>IssueLabels</code>）。</li> <li>使用<code>Issue</code> 类上的方法添加新评论，如<code>Issue.AddComment(...)</code>;。</li> <li>将<code>Issue</code>（包括所有子集合）作为单个数据库操作（更新）保存到数据库。</li></ul> <p>对于以前使用 <strong>EF Core 和关系数据库</strong>的开发人员来说，这似乎很奇怪。获取所有<code>Issue</code>和细节似乎没有必要且效率低下。为什么我们不直接对数据库执行 SQL Insert 命令而不查询任何数据呢？</p> <p>答案是我们应该在<strong>代码</strong>中<strong>实现业务</strong>规则并保持数据的<strong>一致性</strong>和<strong>完整性</strong>。如果我们有一个像“用户不能对锁定的问题发表评论”这样的业务规则，我们如何在不从数据库中检索的情况下检查问题的锁定状态？因此，只有在应用程序代码中相关对象可用时，我们才能执行业务规则。</p> <p>另一方面，<strong>MongoDB</strong> 开发人员会发现这个规则很自然。在 MongoDB 中，聚合对象（带有子集合）保存在数据库中的<strong>单个集合</strong>中（而它分布在关系数据库中的多个表中）。因此，当您获得聚合时，所有子集合都已作为查询的一部分进行检索，无需任何额外配置。</p> <p>ABP 框架有助于在您的应用程序中实现这一原则。</p> <p><strong>示例：向问题添加评论</strong></p> <p><img src="/assets/img/image-20210719220818540.ef479b1e.png" alt="image-20210719220818540"></p> <p><code>_issueRepository.GetAsync</code> 方法默认将<code>Issue</code>及其所有详细信息（子集合）作为一个单元来检索。虽然这对 MongoDB 来说是开箱即用的，但您需要为 EF Core 配置聚合详细信息。但是，一旦您配置好，存储库就会自动处理它。 <code>_issueRepository.GetAsync</code> 方法获取一个可选参数 <code>includeDetails</code>，您可以在需要时传递 <code>false</code> 以禁用此行为。</p> <div class="custom-block tip"><p class="title"></p><p>有关配置和替代方案，请参阅 <a href="https://docs.abp.io/en/abp/latest/Entity-Framework-Core" target="_blank" rel="noopener noreferrer">EF Core 文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的加载相关实体部分。</p></div><p><code>Issue.AddComment</code> 获取用户 ID 和评论文本，实现必要的业务规则并将评论添加到问题的 Comments 集合中。</p> <p>最后，我们使用 <code>_issueRepository.UpdateAsync</code> 来保存对数据库的更改。</p> <div class="custom-block tip"><p class="title"></p><p>EF Core 具有<strong>更改跟踪</strong>功能。因此，您实际上不需要调用 <code>_issueRepository.UpdateAsync</code>。由于 ABP 的工作单元系统会在方法结束时自动调用 <code>DbContext.SaveChanges()</code>，它将自动保存。但是，对于 MongoDB，您需要显式更新更改的实体。</p> <p>因此，如果您想编写与数据库提供程序独立无关的代码，则应始终为更改的实体调用 <code>UpdateAsync</code> 方法。</p></div><h3 id="事务边界"><a href="#事务边界" class="header-anchor">#</a> 事务边界</h3> <p>聚合通常被视为事务边界。如果用例使用单个聚合，读取它并将其保存为单个单元，则对聚合对象所做的所有更改都将作为原子操作一起保存，并且您不需要显式数据库事务。</p> <p>但是，在现实生活中，您可能需要在单个用例中更改<strong>多个聚合实例</strong>，并且需要使用数据库事务来确保<strong>原子更新</strong>和<strong>数据一致性</strong>。因此，ABP 框架针对用例（应用程序服务方法边界）使用显式数据库事务。有关更多信息，请参阅<a href="https://docs.abp.io/en/abp/latest/Unit-Of-Work" target="_blank" rel="noopener noreferrer">工作单元<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>文档。</p> <h3 id="可序列化"><a href="#可序列化" class="header-anchor">#</a> 可序列化</h3> <p>聚合（带有根实体和子集合）应该作为一个单元在网络上可序列化和传输。例如，MongoDB 在保存到数据库时将聚合序列化为 JSON 文档，在从数据库读取时从 JSON 反序列化。</p> <div class="custom-block tip"><p class="title"></p><p>当您使用关系数据库和 ORM 时，此要求不是必需的。然而，它是领域驱动设计的一个重要实践。</p></div><p>以下规则已经带来了可序列化性。</p> <h3 id="聚合-聚合根规则和最佳实践"><a href="#聚合-聚合根规则和最佳实践" class="header-anchor">#</a> 聚合/聚合根规则和最佳实践</h3> <p>以下规则确保实施上述原则。</p> <h3 id="仅通过-id-引用其他聚合"><a href="#仅通过-id-引用其他聚合" class="header-anchor">#</a> 仅通过 ID 引用其他聚合</h3> <p>第一条规则说一个聚合应该只通过它们的 Id 引用其他聚合。这意味着您不能将导航属性添加到其他聚合。</p> <ul><li>该规则使得实现可序列化原则成为可能。</li> <li>它还可以防止不同的聚合相互操纵以及将聚合的业务逻辑相互泄露。</li></ul> <p>在下面的示例中，您会看到两个聚合根，<code>GitRepository</code> 和 <code>Issue</code>；</p> <p><img src="/assets/img/image-20210719223641022.b261e57d.png" alt="image-20210719223641022"></p> <ul><li><code>GitRepository</code> 不应该有<code>Issue</code>的集合，因为它们是不同的聚合。</li> <li><code>Issue</code>不应具有相关 <code>GitRepository</code> 的导航属性，因为它是不同的聚合。</li> <li><code>Issue</code> 可以有 <code>RepositoryId</code>（作为 Guid）。</li></ul> <p>所以，当你有一个<code>Issue</code>并且需要有与这个问题相关的 <code>GitRepository</code> 时，你需要通过 <code>RepositoryId</code> 从数据库中显式查询它。</p> <h3 id="对于-ef-core-和关系数据库"><a href="#对于-ef-core-和关系数据库" class="header-anchor">#</a> 对于 EF Core 和关系数据库</h3> <p>在MongoDB中，自然不适合拥有这样的导航属性/集合。如果这样做，您会在源聚合的数据库集合中找到目标聚合对象的副本，因为它在保存时被序列化为 JSON。</p> <p>但是，EF Core 和关系数据库开发人员可能会发现此限制性规则是不必要的，因为 EF Core 可以在数据库读取和写入时处理它。我们认为这是一项重要规则，有助于降低领域的复杂性，防止潜在问题，我们强烈建议实施此规则。但是，如果您认为忽略此规则是可行的，请参阅上面<em>关于数据库独立性原则</em>的讨论部分。</p> <h3 id="保持聚合小规模"><a href="#保持聚合小规模" class="header-anchor">#</a> 保持聚合小规模</h3> <p>一个好的做法是保持聚合简单和小规模。这是因为聚合将作为单个单元加载和保存，并且读取/写入大对象存在性能问题。请参阅下面的示例：</p> <p><img src="/assets/img/image-20210719224706910.4ee870dc.png" alt="image-20210719224706910"></p> <p>角色聚合具有一组 <code>UserRole</code> 值对象，用于跟踪为此角色分配的用户。请注意， <code>UserRole</code> 不是另一个聚合，并且它对于规则 <em>仅按 ID 引用其他聚合</em> 来说不是问题。然而，这在实践中是一个问题。在现实生活场景中，一个角色可能会分配给数千（甚至数百万）个用户，每当您从数据库中查询一个角色时，加载数千个项目是一个重大的性能问题（请记住：聚合由它们的子集合作为一个单元加载）。</p> <p>另一方面， <code>User</code> 可能有这样一个 <code>Roles</code> 集合，因为用户实际上没有太多角色，并且在使用 User Aggregate 时拥有一个角色列表会很有用。</p> <p>如果仔细想想，当使用非关系型数据库（如 MongoDB）时 Role 和 User 都有关系列表时，还有一个问题。在这种情况下，相同的信息会在不同的集合中重复，并且很难保持数据的一致性（每当您将项目添加到 <code>User.Roles</code> 时，您也需要将其添加到 <code>Role.Users</code>）。</p> <p>因此，请根据以下考虑确定聚合边界和大小；</p> <ul><li>一起使用的对象。</li> <li>查询（加载/保存）性能和内存消耗。</li> <li>数据完整性、有效性和一致性。</li></ul> <p>在实践中；</p> <ul><li>大多数聚合根<strong>不会有子集合</strong>。</li> <li>在大多数情况下，一个子集合中的项目不应超过 <strong>100-150</strong> 个。如果您认为一个集合可能包含更多项，请不要将集合定义为聚合的一部分，而是考虑为集合内的实体提取另一个聚合根。</li></ul> <h3 id="聚合根-实体上的主键"><a href="#聚合根-实体上的主键" class="header-anchor">#</a> 聚合根/实体上的主键</h3> <ul><li>聚合根通常具有单个 <code>Id</code> 属性作为其标识符（Primark Key：PK）。我们更喜欢 <code>Guid</code> 作为聚合根实体的 PK（请参阅 <a href="https://docs.abp.io/en/abp/latest/Guid-Generation" target="_blank" rel="noopener noreferrer">Guid 生成文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>以了解原因）。</li> <li>聚合中的实体（不是聚合根）可以使用复合主键</li></ul> <p>例如，请参阅下面的聚合根和实体：</p> <p><img src="/assets/img/image-20210719225910436.40d3508b.png" alt="image-20210719225910436"></p> <ul><li><code>Organization</code> 有一个 <code>Guid</code> 标识符 (<code>Id</code>)。</li> <li><code>OrganizationUser</code> 是一个 <code>Organization</code> 的子集合，并且有一个由 <code>OrganizationId</code> 和 <code>UserId</code> 组成的复合主键。</li></ul> <p>这并不意味着子集合实体应该始终具有复合 PK。需要时，它们可能具有单个 Id 属性。</p> <div class="custom-block tip"><p class="title"></p><p>复合 PK 实际上是关系数据库的一个概念，因为子集合实体有自己的表，需要一个 PK。另一方面，例如，在 MongoDB 中，您根本不需要为子集合实体定义 PK，因为它们作为聚合根的一部分存储。</p></div><h3 id="聚合根-实体的构造函数"><a href="#聚合根-实体的构造函数" class="header-anchor">#</a> 聚合根/实体的构造函数</h3> <p>构造函数位于实体生命周期开始的地方。设计良好的构造函数有一些责任：</p> <ul><li>获取<strong>所需的实体属性</strong>作为参数以<strong>创建有效实体</strong>。应该强制仅传递必需的参数，并且可能会获取非必需的属性作为可选参数。</li> <li>检查参数的<strong>有效性</strong>。</li> <li>初始化<strong>子集合</strong>。</li></ul> <p><strong>示例<code>Issue</code>（聚合根）构造函数</strong></p> <p><img src="/assets/img/image-20210719230937729.b9d5e87c.png" alt="image-20210719230937729"></p> <ul><li><code>Issue</code>类通过在其构造函数中获取最少必需的属性作为参数来正确<strong>强制创建有效实体</strong>。</li> <li>构造函数验证输入（如果给定值为空，<code>Check.NotNullOrWhiteSpace(...)</code> 抛出 <code>ArgumentException</code>）。</li> <li>它会<strong>初始化子集合</strong>，因此当您在创建<code>Issue</code>后尝试使用 <code>Labels</code> 集合时，不会出现空引用异常。</li> <li>构造函数也<strong>接受</strong> <code>id</code> 并传递给基类。我们不会在构造函数中生成 <code>Guid</code>，以便能够将此责任委托给另一个服务（请参阅 <a href="https://docs.abp.io/en/abp/latest/Guid-Generation" target="_blank" rel="noopener noreferrer">生成Guid<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li> <li>ORM 需要私有的<strong>空构造函数</strong>。我们将其设为<code>private</code>以防止在我们自己的代码中意外使用它。</li></ul> <div class="custom-block tip"><p class="title"></p><p>请参阅<a href="https://docs.abp.io/en/abp/latest/Entities" target="_blank" rel="noopener noreferrer">实体<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>文档以了解有关使用 ABP 框架创建实体的更多信息。</p></div><h3 id="实体属性访问器和方法"><a href="#实体属性访问器和方法" class="header-anchor">#</a> 实体属性访问器和方法</h3> <p>你可能觉得上面的例子很奇怪！例如，我们强制在构造函数中传递一个非空的 <code>Title</code>。但是，开发人员随后可以在没有任何控制的情况下将 <code>Title</code> 属性设置为 <code>null</code>。这是因为上面的示例代码只关注构造函数。</p> <p>如果我们使用公共 设置器声明所有属性（如上面的示例 <code>Issue</code> 类），我们无法强制实体在其生命周期中的有效性和完整性。所以;</p> <ul><li>当您在设置该属性时需要执行任何逻辑时，请为该属性使用<strong>私有设置器</strong>。</li> <li>定义公共方法来操作这些属性。</li></ul> <p><strong>示例：以受控方式更改属性的方法</strong></p> <p><img src="/assets/img/image-20210719230742649.4c17219b.png" alt="image-20210719230742649"></p> <ul><li><code>RepositoryId</code> 设置器设为私有，创建<code>Issue</code>后无法更改它，因为这是我们在此领域中想要的：问题不能移动到另一个存储库。</li> <li>如果您想稍后以受控方式更改它，则将<code>Title</code> 设置器设为私有并创建 SetTitle 方法。</li> <li><code>Text</code> 和 <code>AssignedUserId</code> 具有公共设置器，因为对它们没有限制。它们可以为 null 或任何其他值。我们认为没有必要定义单独的方法来设置它们。如果我们稍后需要，我们可以添加方法并使 设置器成为私有。领域层中的重大更改不是问题，因为领域层是一个内部项目，它不会暴露给客户端。</li> <li><code>IsClosed</code> 和 <code>IssueCloseReason</code> 是对属性。定义 <code>Close</code> 和 <code>ReOpen</code> 方法来一起改变它们。通过这种方式，我们可以防止无故关闭问题。</li></ul> <h3 id="实体中的业务逻辑和异常"><a href="#实体中的业务逻辑和异常" class="header-anchor">#</a> 实体中的业务逻辑和异常</h3> <p>当您在实体中实现验证和业务逻辑时，您经常需要管理异常情况。在这些情况下；</p> <ul><li>创建<strong>领域特定的异常</strong></li> <li>必要时在实体方法中<strong>抛出这些异常</strong>。</li></ul> <p><strong>示例：</strong></p> <p><img src="/assets/img/image-20210719233614479.75d23c1d.png" alt="image-20210719233614479"></p> <p>这里有两个业务规则；</p> <ul><li>无法重新打开锁定的问题。</li> <li>您无法锁定未解决的问题。</li></ul> <p>在这些情况下，<code>Issue</code>类会抛出一个 <code>IssueStateException</code> 以强制执行业务规则：</p> <p><img src="/assets/img/image-20210719234426545.f16b4e9f.png" alt="image-20210719234426545"></p> <p>抛出这样的异常有两个潜在的问题；</p> <ol><li>如果出现此类异常，<strong>最终用户</strong>是否应该看到异常（错误）消息？如果是这样，您如何<strong>本地化</strong>异常消息？您不能使用<a href="https://docs.abp.io/en/abp/latest/Localization" target="_blank" rel="noopener noreferrer">本地化系统<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，因为您不能在实体中注入和使用 <code>IStringLocalizer</code>。</li> <li>对于 Web 应用程序或 HTTP API，应该向客户端返回什么 <strong>HTTP 状态码</strong>？</li></ol> <p>ABP 的<a href="https://docs.abp.io/en/abp/latest/Exception-Handling" target="_blank" rel="noopener noreferrer">异常处理系统<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>解决了这些和类似的问题。</p> <p><strong>示例：使用代码抛出业务异常</strong></p> <p><img src="/assets/img/image-20210719234344275.8557993c.png" alt="image-20210719234344275"></p> <ul><li><code>IssueStateException</code> 类继承了 <code>BusinessException</code> 类。对于从 <code>BusinessException</code> 派生的异常，ABP 默认返回 403（禁止）HTTP 状态代码（而不是 500 - 内部服务器错误）。</li> <li>该<code>code</code>用作本地化资源文件中的关键字，用于查找本地化消息。</li></ul> <p>现在，我们可以更改 <code>ReOpen</code> 方法，如下所示：</p> <p><img src="/assets/img/image-20210719234742121.404ead67.png" alt="image-20210719234742121"></p> <div class="custom-block tip"><p class="title"></p><p>使用常量而不是魔术字符串。</p></div><p>并向本地化资源添加一个条目，如下所示：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;IssueTracking:CanNotOpenLockedIssue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Can not open a locked issue! Unlock it first.&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>当您抛出异常时，ABP 会自动使用此本地化消息（基于当前语言）向最终用户显示。</li> <li>异常代码（这里是IssueTracking:CanNotOpenLockedIssue）也被发送到客户端，所以它可以以编程方式处理错误情况。</li></ul> <div class="custom-block tip"><p class="title"></p><p>对于此示例，您可以直接抛出 <code>BusinessException</code> 而不是定义专门的 <code>IssueStateException</code>。结果将是相同的。有关所有详细信息，请参阅<a href="https://docs.abp.io/en/abp/latest/Exception-Handling" target="_blank" rel="noopener noreferrer">异常处理文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p></div><h3 id="实体中的业务逻辑依赖外部服务"><a href="#实体中的业务逻辑依赖外部服务" class="header-anchor">#</a> 实体中的业务逻辑依赖外部服务</h3> <p>当业务逻辑仅使用该实体的属性时，在实体方法中实现业务规则很简单。如果业务逻辑需要<strong>查询数据库</strong>或使用任何应该从<a href="https://docs.abp.io/en/abp/latest/Dependency-Injection" target="_blank" rel="noopener noreferrer">依赖注入<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>系统解析的<strong>外部服务</strong>怎么办。记住;实体不能注入服务！</p> <p>有两种常见的方式来实现这样的业务逻辑：</p> <ul><li>在实体方法上实现业务逻辑并<strong>获取外部依赖项作为方法的参数</strong>。</li> <li>创建<strong>领域服务</strong>。</li></ul> <p>领域服务将在后面解释。但是，现在让我们看看它是如何在实体类中实现的。</p> <p><strong>示例：业务规则：不能同时为用户分配超过 3 个未解决的问题</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Issue</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AggregateRoot<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> AssignedUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">AssignToAsync</span><span class="token punctuation">(</span><span class="token class-name">AppUser</span> user<span class="token punctuation">,</span> <span class="token class-name">IUserIssueService</span> userIssueService<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> openIssueCount <span class="token operator">=</span> <span class="token keyword">await</span> userIssueService<span class="token punctuation">.</span><span class="token function">GetOpenIssueCountAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>openIssueCount <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">&quot;IssueTracking:ConcurrentOpenIssueLimit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        AssignedUserId <span class="token operator">=</span> user<span class="token punctuation">.</span>Id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CleanAssignment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        AssignedUserId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><ul><li><code>AssignedUserId</code> 属性设置器设为私有。因此，只能使用 <code>AssignToAsync</code> 和 <code>CleanAssignment</code> 方法更改它。</li> <li><code>AssignToAsync</code> 获取一个 <code>AppUser</code> 实体。实际上，它只使用 <code>user.Id</code>，因此您可以获得 <code>Guid</code> 值，例如 <code>userId</code>。但是，这种方式可以确保 <code>Guid</code> 值是现有用户的 <code>Id</code> 而不是随机的 <code>Guid</code> 值。</li> <li><code>IUserIssueService</code> 是一种任意服务，用于获取用户的未解决问题计数。代码部分（调用<code>AssignToAsync</code>）负责解析IUserIssueService 并传递到这里。</li> <li>如果业务规则不满足，<code>AssignToAsync</code> 会抛出异常。</li> <li>最后，如果一切正确，则设置 <code>AssignedUserId</code> 属性。</li></ul> <p>当您想将问题分配给用户时，此方法完美地保证了应用业务逻辑。但是，它有一些问题；</p> <ul><li>它使实体类依<strong>赖于外部服务</strong>这将使实体变得<strong>复杂</strong>。</li> <li>它让实体变得难以使用。使用实体的代码现在需要注入<code>IUserIssueService</code> 并传递给 <code>AssignToAsync</code> 方法。</li></ul> <p>实现此业务逻辑的另一种方法是引入<strong>领域服务</strong>，稍后将对此进行解释。</p> <h3 id="存储库"><a href="#存储库" class="header-anchor">#</a> 存储库</h3> <p><a href="https://docs.abp.io/en/abp/latest/Repositories" target="_blank" rel="noopener noreferrer">存储库<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是一个类似集合的接口，领域和应用层使用它来访问数据持久性系统（数据库）以读取和写入业务对象，通常是聚合。</p> <p>常见的存储库原则是；</p> <ul><li>在<strong>领域层定义一个存储库接口</strong>（因为它将在领域和应用层中使用），<strong>在基础设施层实现</strong>（启动模板中<em>EntityFrameworkCore</em>项目）。</li> <li>不要在存储库中包含业务逻辑。</li> <li>存储库接口应该独立于<strong>数据库提供者/ORM</strong>。例如，不要从存储库方法返回 <code>DbSet</code>。 <code>DbSet</code> 是 EF Core 提供的对象。</li> <li><strong>为聚合根创建存储库</strong>，而不是为所有实体创建存储库。因为，应该通过聚合根访问子集合实体（聚合的）。</li></ul> <p><strong>不要在存储库中包含领域逻辑</strong></p> <p>虽然这条规则一开始看起来很明显，但很容易将业务逻辑泄漏到存储库中。</p> <p><strong>示例：从存储库中获取非活动问题</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Volo<span class="token punctuation">.</span>Abp<span class="token punctuation">.</span>Domain<span class="token punctuation">.</span>Repositories</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">IssueTracking<span class="token punctuation">.</span>Issues</span>
<span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IIssueRepository</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span></span>
    <span class="token punctuation">{</span>
    	<span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetInActiveIssuesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><code>IIssueRepository</code> 通过添加 <code>GetInActiveIssuesAsync</code> 方法扩展了标准 <code>IRepository&lt;...&gt;</code> 接口。这个存储库与下面这样一个问题类一起工作：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Issue</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AggregateRoot<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IHasCreationTime</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsClosed <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> AssignedUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreationTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime<span class="token punctuation">?</span></span> LastCommentTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>（代码只显示了我们在这个例子中需要的属性）</p> <p>规则说存储库不应该知道业务规则。这里的问题是“<strong>什么是非活动问题</strong>？它是一个业务规则定义吗？”</p> <p>让我们看一下实现来理解它：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">IssueTracking<span class="token punctuation">.</span>EntityFrameworkCore</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>EntityFrameworkCore</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Volo<span class="token punctuation">.</span>Abp<span class="token punctuation">.</span>Domain<span class="token punctuation">.</span>Repositories<span class="token punctuation">.</span>EntityFrameworkCore</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Volo<span class="token punctuation">.</span>Abp<span class="token punctuation">.</span>EntityFrameworkCore</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">IssueTracking<span class="token punctuation">.</span>Issues</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EfCoreIssueRepository</span> <span class="token punctuation">:</span>
        <span class="token type-list"><span class="token class-name">EfCoreRepository<span class="token punctuation">&lt;</span>IssueTrackingDbContext<span class="token punctuation">,</span> Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
        <span class="token class-name">IIssueRepository</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">EfCoreIssueRepository</span><span class="token punctuation">(</span>
            <span class="token class-name">IDbContextProvider<span class="token punctuation">&lt;</span>IssueTrackingDbContext<span class="token punctuation">&gt;</span></span> dbContextProvider<span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>dbContextProvider<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetInActiveIssuesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> daysAgo30 <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">Subtract</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromDays</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> dbSet <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetDbSetAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> dbSet<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>i <span class="token operator">=&gt;</span>

                <span class="token comment">//Open</span>
                <span class="token operator">!</span>i<span class="token punctuation">.</span>IsClosed <span class="token operator">&amp;&amp;</span>

                <span class="token comment">//Assigned to nobody</span>
                i<span class="token punctuation">.</span>AssignedUserId <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>

                <span class="token comment">//Created 30+ days ago</span>
                i<span class="token punctuation">.</span>CreationTime <span class="token operator">&lt;</span> daysAgo30 <span class="token operator">&amp;&amp;</span>

                <span class="token comment">//No comment or the last comment was 30+ days ago</span>
                <span class="token punctuation">(</span>i<span class="token punctuation">.</span>LastCommentTime <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> i<span class="token punctuation">.</span>LastCommentTime <span class="token operator">&lt;</span> daysAgo30<span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>（使用 EF Core 进行实现。请参阅 <a href="https://docs.abp.io/en/abp/latest/Entity-Framework-Core" target="_blank" rel="noopener noreferrer">EF Core 集成文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>以了解如何使用 EF Core 创建自定义存储库。）</p> <p>当我们检查 <code>GetInActiveIssuesAsync</code> 实现时，我们看到一个定义非活动问题的业务规则：问题应该是开放的，没有分配给任何人，在 30 天以前创建并且在过去 30 天内没有评论。</p> <p>这是隐藏在存储库方法中的业务规则的隐式定义。当我们需要重用这个业务逻辑时，就会出现问题。</p> <p>例如，假设我们要在 <code>Issue</code> 实体上添加一个 <code>bool IsInActive()</code> 方法。这样，当我们有一个问题实体时，我们可以检查活跃度。</p> <p>让我们看看实现：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Issue</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AggregateRoot<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IHasCreationTime</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsClosed <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> AssignedUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreationTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime<span class="token punctuation">?</span></span> LastCommentTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">//...</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">IsInActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> daysAgo30 <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">Subtract</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromDays</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span>
            <span class="token comment">//Open</span>
            <span class="token operator">!</span>IsClosed <span class="token operator">&amp;&amp;</span>

            <span class="token comment">//Assigned to nobody</span>
            AssignedUserId <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>

            <span class="token comment">//Created 30+ days ago</span>
            CreationTime <span class="token operator">&lt;</span> daysAgo30 <span class="token operator">&amp;&amp;</span>

            <span class="token comment">//No comment or the last comment was 30+ days ago</span>
            <span class="token punctuation">(</span>LastCommentTime <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> LastCommentTime <span class="token operator">&lt;</span> daysAgo30<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>我们不得不复制/粘贴/修改代码。如果活跃度的定义发生变化怎么办？我们不应该忘记更新这两个地方。这是业务逻辑的重复，非常危险。</p> <p>这个问题的一个很好的解决方案是<em>规约模式</em>！</p> <h3 id="规约"><a href="#规约" class="header-anchor">#</a> 规约</h3> <p><a href="https://docs.abp.io/en/abp/latest/Specifications" target="_blank" rel="noopener noreferrer">规约<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是一个<strong>命名的</strong>、<strong>可重用的</strong>、<strong>可组合的</strong>和<strong>可测试</strong>的类，用于根据业务规则过滤领域对象。</p> <p>ABP 框架提供了必要的基础设施来轻松创建规约类并在您的应用程序代码中使用它们。让我们将非活动问题过滤器实现为规约类：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq<span class="token punctuation">.</span>Expressions</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Volo<span class="token punctuation">.</span>Abp<span class="token punctuation">.</span>Specifications</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">IssueTracking<span class="token punctuation">.</span>Issues</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InActiveIssueSpecification</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Specification<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">&gt;</span></span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">ToExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> daysAgo30 <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">Subtract</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromDays</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> i <span class="token operator">=&gt;</span>
                <span class="token comment">//Open</span>
                <span class="token operator">!</span>i<span class="token punctuation">.</span>IsClosed <span class="token operator">&amp;&amp;</span>

                <span class="token comment">//Assigned to nobody</span>
                i<span class="token punctuation">.</span>AssignedUserId <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>

                <span class="token comment">//Created 30+ days ago</span>
                i<span class="token punctuation">.</span>CreationTime <span class="token operator">&lt;</span> daysAgo30 <span class="token operator">&amp;&amp;</span>

                <span class="token comment">//No comment or the last comment was 30+ days ago</span>
                <span class="token punctuation">(</span>i<span class="token punctuation">.</span>LastCommentTime <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> i<span class="token punctuation">.</span>LastCommentTime <span class="token operator">&lt;</span> daysAgo30<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p><code>Specification&lt;T&gt;</code> 基类通过定义表达式简化了创建规约类的过程。仅仅从存储库中将表达式移到此处。</p> <p>现在，我们可以重用 <code>Issue</code> 实体和 <code>EfCoreIssueRepository</code> 类中的 <code>InActiveIssueSpecification</code>。</p> <p><strong>在实体中使用规约</strong></p> <p>规约类提供了一个 <code>IsSatisfiedBy</code> 方法，如果给定的对象（实体）满足规约，则该方法返回 <code>true</code>。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Issue</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AggregateRoot<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IHasCreationTime</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsClosed <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> AssignedUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreationTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime<span class="token punctuation">?</span></span> LastCommentTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">//...</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">IsInActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InActiveIssueSpecification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsSatisfiedBy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>仅仅创建了 <code>InActiveIssueSpecification</code> 的一个新实例，并使用其 <code>IsSatisfiedBy</code> 方法重新使用了规约定义的表达式。</p> <p><strong>在存储库中使用规约</strong></p> <p>首先，从存储库接口开始：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IIssueRepository</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
	<span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetIssuesAsync</span><span class="token punctuation">(</span><span class="token class-name">ISpecification<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">&gt;</span></span> spec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>通过获取规约对象，将 <code>GetInActiveIssuesAsync</code> 重命名为简单的 <code>GetIssuesAsync</code>。由于<strong>规约（过滤器）已移出存储库</strong>，我们不再需要创建不同的方法来获取具有不同条件的问题（例如 <code>GetAssignedIssues(...)</code>、<code>GetLockedIssues(...)</code> 等）</p> <p>更新后的存储库的实现如下：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EfCoreIssueRepository</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">EfCoreRepository<span class="token punctuation">&lt;</span>IssueTrackingDbContext<span class="token punctuation">,</span> Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
    <span class="token class-name">IIssueRepository</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">EfCoreIssueRepository</span><span class="token punctuation">(</span>
        <span class="token class-name">IDbContextProvider<span class="token punctuation">&lt;</span>IssueTrackingDbContext<span class="token punctuation">&gt;</span></span> dbContextProvider<span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>dbContextProvider<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetIssuesAsync</span><span class="token punctuation">(</span><span class="token class-name">ISpecification<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">&gt;</span></span> spec<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> dbSet <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetDbSetAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> dbSet
            <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>spec<span class="token punctuation">.</span><span class="token function">ToExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>由于 <code>ToExpression()</code> 方法返回一个表达式，因此可以直接传递给 <code>Where</code> 方法来过滤实体。</p> <p>最后，我们可以将任何规约实例传递给 <code>GetIssuesAsync</code> 方法：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IssueAppService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ApplicationService</span><span class="token punctuation">,</span> <span class="token class-name">IIssueAppService</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IIssueRepository</span> _issueRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">IssueAppService</span><span class="token punctuation">(</span><span class="token class-name">IIssueRepository</span> issueRepository<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _issueRepository <span class="token operator">=</span> issueRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">DoItAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> issues <span class="token operator">=</span> <span class="token keyword">await</span> _issueRepository<span class="token punctuation">.</span><span class="token function">GetIssuesAsync</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InActiveIssueSpecification</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>使用默认存储库</strong></p> <p>实际上，您不必创建自定义存储库即可使用规约。标准的 <code>IRepository</code> 已经扩展了 <code>IQueryable</code>，所以你可以在它上面使用标准的 LINQ 扩展方法：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IssueAppService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ApplicationService</span><span class="token punctuation">,</span> <span class="token class-name">IIssueAppService</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> _issueRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">IssueAppService</span><span class="token punctuation">(</span><span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> issueRepository<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _issueRepository <span class="token operator">=</span> issueRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">DoItAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> queryable <span class="token operator">=</span> <span class="token keyword">await</span> _issueRepository<span class="token punctuation">.</span><span class="token function">GetQueryableAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> issues <span class="token operator">=</span> AsyncExecuter<span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span>
            queryable<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">InActiveIssueSpecification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><code>AsyncExecuter</code> 是 ABP 框架提供的实用程序，用于在不依赖于 EF Core NuGet 包的情况下使用异步 LINQ 扩展方法（如此处的 <code>ToListAsync</code>）。有关更多信息，请参阅<a href="https://docs.abp.io/en/abp/latest/Repositories" target="_blank" rel="noopener noreferrer">存储库文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p><strong>组合规约</strong></p> <p>规约的一个强大方面是它们是可组合的。假设我们有另一个规范，仅当<code>Issue</code>在里程碑中时才返回 <code>true</code>：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MilestoneSpecification</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Specification<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> MilestoneId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">MilestoneSpecification</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> milestoneId<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        MilestoneId <span class="token operator">=</span> milestoneId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">ToExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> i <span class="token operator">=&gt;</span> i<span class="token punctuation">.</span>MilestoneId <span class="token operator">==</span> MilestoneId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>该规约是有参数的，这与 <code>InActiveIssueSpecification</code> 有所不同。我们可以组合这两个规约来获取特定里程碑中的非活动问题列表：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IssueAppService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ApplicationService</span><span class="token punctuation">,</span> <span class="token class-name">IIssueAppService</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> _issueRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">IssueAppService</span><span class="token punctuation">(</span><span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> issueRepository<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _issueRepository <span class="token operator">=</span> issueRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">DoItAsync</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> milestoneId<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> queryable <span class="token operator">=</span> <span class="token keyword">await</span> _issueRepository<span class="token punctuation">.</span><span class="token function">GetQueryableAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> issues <span class="token operator">=</span> AsyncExecuter<span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span>
            queryable
                <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InActiveIssueSpecification</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">And</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">MilestoneSpecification</span><span class="token punctuation">(</span>milestoneId<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">ToExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>上面的示例使用 <code>And</code> 扩展方法来组合规约。还有更多的组合方法可用，例如 <code>Or(...)</code> 和 <code>AndNot(...)</code>。</p> <div class="custom-block tip"><p class="title"></p><p>有关 ABP 框架提供的规约基础结构的更多详细信息，请参阅<a href="">规约文档</a>。</p></div><h2 id="领域服务"><a href="#领域服务" class="header-anchor">#</a> 领域服务</h2> <p>//TODO</p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">7/21/2021, 2:29:46 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/blogs/2021/Implementing_Domain_Driven_Design/03_Implementation_The_Big_Picture.html" class="prev">
            实现领域驱动设计-实现：全景图
          </a></span> <span class="next"><a href="/blogs/2021/Implementing_Domain_Driven_Design/05_Example_User_Cases.html">
            实现领域驱动设计-用例
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#领域示例" class="sidebar-link reco-side-领域示例" data-v-70334359>领域示例</a></li><li class="level-2" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#聚合" class="sidebar-link reco-side-聚合" data-v-70334359>聚合</a></li><li class="level-2" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#聚合-聚合根原则" class="sidebar-link reco-side-聚合-聚合根原则" data-v-70334359>聚合/聚合根原则</a></li><li class="level-3" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#业务规则" class="sidebar-link reco-side-业务规则" data-v-70334359>业务规则</a></li><li class="level-3" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#单个单元" class="sidebar-link reco-side-单个单元" data-v-70334359>单个单元</a></li><li class="level-3" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#事务边界" class="sidebar-link reco-side-事务边界" data-v-70334359>事务边界</a></li><li class="level-3" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#可序列化" class="sidebar-link reco-side-可序列化" data-v-70334359>可序列化</a></li><li class="level-3" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#聚合-聚合根规则和最佳实践" class="sidebar-link reco-side-聚合-聚合根规则和最佳实践" data-v-70334359>聚合/聚合根规则和最佳实践</a></li><li class="level-3" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#仅通过-id-引用其他聚合" class="sidebar-link reco-side-仅通过-id-引用其他聚合" data-v-70334359>仅通过 ID 引用其他聚合</a></li><li class="level-3" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#对于-ef-core-和关系数据库" class="sidebar-link reco-side-对于-ef-core-和关系数据库" data-v-70334359>对于 EF Core 和关系数据库</a></li><li class="level-3" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#保持聚合小规模" class="sidebar-link reco-side-保持聚合小规模" data-v-70334359>保持聚合小规模</a></li><li class="level-3" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#聚合根-实体上的主键" class="sidebar-link reco-side-聚合根-实体上的主键" data-v-70334359>聚合根/实体上的主键</a></li><li class="level-3" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#聚合根-实体的构造函数" class="sidebar-link reco-side-聚合根-实体的构造函数" data-v-70334359>聚合根/实体的构造函数</a></li><li class="level-3" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#实体属性访问器和方法" class="sidebar-link reco-side-实体属性访问器和方法" data-v-70334359>实体属性访问器和方法</a></li><li class="level-3" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#实体中的业务逻辑和异常" class="sidebar-link reco-side-实体中的业务逻辑和异常" data-v-70334359>实体中的业务逻辑和异常</a></li><li class="level-3" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#实体中的业务逻辑依赖外部服务" class="sidebar-link reco-side-实体中的业务逻辑依赖外部服务" data-v-70334359>实体中的业务逻辑依赖外部服务</a></li><li class="level-3" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#存储库" class="sidebar-link reco-side-存储库" data-v-70334359>存储库</a></li><li class="level-3" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#规约" class="sidebar-link reco-side-规约" data-v-70334359>规约</a></li><li class="level-2" data-v-70334359><a href="/blogs/2021/Implementing_Domain_Driven_Design/04_Implementation_The_Building_Blocks.html#领域服务" class="sidebar-link reco-side-领域服务" data-v-70334359>领域服务</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----></div></div>
    <script src="/assets/js/app.3aafe313.js" defer></script><script src="/assets/js/4.95e160e0.js" defer></script><script src="/assets/js/1.885e2cda.js" defer></script><script src="/assets/js/7.8cb06d6a.js" defer></script>
  </body>
</html>
